<?xml version="1.0" encoding="UTF-8"?>
<nsjusecase xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../vendor/nasajon/mdatransformer/schemas/nsjusecase.xsd" name="fornecedoresenvolvidos" label="fornecedoresenvolvidos" project="crm" orphan="false">
  <entity schema="crm" table="fornecedoresenvolvidos">
    <!--
      Atenção:
      ao realizar alterações neste model, por favor conferir o arquivo 
      AppBundle/Repository/Crm/NegociosRepository.php
      e fazer as devidas modificações (pois o repository foi sobrescrito)
    -->
    <fieldmodel name="fornecedorenvolvido" datatype="guid" isid="true" column="fornecedorenvolvido"/>
    <fieldmodel name="negocio" datatype="guid" column="negocio" useCaseLink="crm\atcs" entityJoinType="left"/>
    <fieldmodel name="fornecedor" datatype="guid" column="fornecedor" useCaseLink="ns\fornecedores" entityJoinType="left"/>
    <fieldmodel name="acionamentodata" datatype="datetime" column="acionamentodata" />
    <fieldmodel name="acionamentorespostaprazo" datatype="float" column="acionamentorespostaprazo" />
    <fieldmodel name="acionamentorespostaprazoflag" datatype="boolean" notMapped="true" />
    <fieldmodel name="acionamentoaceito" datatype="boolean" column="acionamentoaceito" />
    <fieldmodel name="acionamentometodo" datatype="integer" column="acionamentometodo" >
        <options>{"1":"Sistema","2":"Email","3":"Telefone"}</options>
    </fieldmodel>
    <fieldmodel name="created_at" datatype="datetime"  column="created_at"/>
    <fieldmodel name="created_by" datatype="json"  column="created_by"/>
    <fieldmodel name="updated_at" datatype="datetime"  column="updated_at"/>
    <fieldmodel name="updated_by" datatype="json"  column="updated_by"/>
    <fieldmodel name="tenant" datatype="integer"  column="tenant"/>

    <!-- Utilizado para criar um bloco que será substituído no modal de criação -->
    <fieldmodel name="block_mensagem" datatype="string" notMapped="true"/>
    <fieldmodel name="fornecedorenvolvidosanexo" datatype="objectlist" column="fornecedorenvolvido" useCaseLink="crm\fornecedoresenvolvidosanexos" entityJoinType="left" />
    <fieldmodel name="id_grupoempresarial" datatype="guid" column="id_grupoempresarial"/>
    <fieldmodel name="proposta" datatype="string" notMapped="true" />
    <!-- Configurações de desconto -->
    <fieldmodel name="possuidescontoparcial" datatype="boolean" column="possuidescontoparcial" />
    <fieldmodel name="possuidescontoglobal" datatype="boolean" column="possuidescontoglobal" />
    <fieldmodel name="descontoglobal" datatype="float" column="descontoglobal"/>
    <!-- 1: Valor. 2: Percentual -->
    <fieldmodel name="descontoglobaltipo" datatype="integer" column="descontoglobaltipo"/> 
    <!-- Valor unitário a ser preenchido nos orçamentos -->
    <fieldmodel name="descontoglobalunitario" datatype="float" notMapped="true" />
    <!-- Valor de resto, nos casos que a divisão pelos orçamentos não for exata -->
    <fieldmodel name="descontoglobalresto" datatype="float" notMapped="true" />
    <!-- Quando houver resto do desconto global, utilizado para preencher qual orçamento está com o desconto diferente -->
    <fieldmodel name="descontoglobalrestoorcamento" datatype="string" notMapped="true" />
  </entity>
  <constructors>
    <constructoritem>tenant</constructoritem>
    <constructoritem>negocio</constructoritem>
    <constructoritem>id_grupoempresarial</constructoritem>
  </constructors>
  <viewbrowser label="Fornecedores Envolvidos" layout="list" paginate="true" target="window">
    <fieldsbrowser>
      <fieldbrowser entitylink="fornecedorenvolvido" isid="true" visible="false"/>
      <fieldbrowser entitylink="acionamentodata" visible="false" cansearch="false" />
      <fieldbrowser entitylink="acionamentorespostaprazo" visible="false" cansearch="false" />
      <fieldbrowser entitylink="acionamentoaceito" visible="false" cansearch="false" />
      <fieldbrowser entitylink="acionamentometodo" visible="false" cansearch="false" />
      <fieldbrowser entitylink="created_by" visible="false" cansearch="false" />
      <fieldbrowser entitylink="negocio" visible="false" cansearch="false" fielddetaillookup="{'codigo': 'Codigo'}" />
      <fieldbrowser entitylink="fornecedor" visible="false" cansearch="false" fielddetaillookup="{'codigofornecedores': 'Codigo'}" />
    </fieldsbrowser>
        <filters style="fixed">
            <fieldsfilters>
                <fieldfilter entitylink="negocio"  maxoccurs='unbounded'>
                    <lookup fielddetail="{'codigo':'Codigo'}" allowinsert="false" />
                    <conditions>
                        <condition type="eq"/>
                    </conditions>
                </fieldfilter>
                <fieldfilter entitylink="fornecedor"  maxoccurs='unbounded' visible="false">
                    <conditions>
                        <condition type="eq"/>
                    </conditions>
                </fieldfilter>
            </fieldsfilters>
        </filters>
  </viewbrowser>
  <forms>
    <form name="default" label="Acionamento e Solicitação de Orçamento">
        <layout>
            <headerform>
                <row>
                    <cell controltype="textedit" colspan="12" entitylink="block_mensagem">
                    </cell>
                    <cell controltype="lookup" colspan="0" entitylink="fornecedor" fielddetaillookup="{'codigo':'Codigo'}" amountfieldslookup="1" allowinsertlookup="true">
                        <validates>
                            <validate type="vnull" displaytext="O campo Fornecedor não pode ser vazio."/>
                        </validates>
                    </cell>
                </row>
                <row>
                    <cell name="acionamentometodo" entitylink="acionamentometodo" colspan="7" label="Via de acionamento" controltype="combobox">
                        <validates>
                            <validate type="vnull" displaytext="O campo Via de acionamento não pode estar vazio." />
                        </validates>
                    </cell>
                    <cell controltype="number" label="Tempo limite de espera" colspan="5" entitylink="acionamentorespostaprazo">
                        <validates>
                            <validate type="vnull" displaytext="O campo Tempo limite de espera não pode estar vazio"></validate>
                            <validate type="greaterthan" value="0" displaytext="O Tempo limite de espera deve ser maior que 0."/>
                        </validates>
                    </cell>
                    <cell controltype="textedit"  colspan="5" entitylink="proposta">
                        <validates>
                            <validate type="vnull" displaytext="O campo proposta não pode estar vazio"></validate>
                        </validates>
                    </cell>
                </row>
            </headerform>
        </layout>
    </form>
    <form name="aprovar" label="Aprovação de Orçamentos">
        <layout>
            <headerform>
                <row>
                    <cell controltype="lookup" colspan="0" entitylink="fornecedor" fielddetaillookup="{'codigo':'Codigo'}" amountfieldslookup="1">
                        <validates>
                            <validate type="vnull" displaytext="O campo Fornecedor não pode ser vazio."/>
                        </validates>
                    </cell>
                </row>
                <row>
                    <cell controltype="textedit"  colspan="5" entitylink="proposta">
                        <validates>
                            <validate type="vnull" displaytext="O campo proposta não pode estar vazio"></validate>
                        </validates>
                    </cell>
                </row>
            </headerform>
        </layout>
    </form>
    <form name="reabrir">
        <layout>
            <headerform>
            </headerform>
        </layout>
    </form>
    <form name="atualizarconfiguracaodescontos">
        <layout>
            <headerform>
                <row>
                    <cell controltype="lookup" colspan="0" entitylink="fornecedor" fielddetaillookup="{'codigo':'Codigo'}" amountfieldslookup="1" allowinsertlookup="true">
                        <validates>
                            <validate type="vnull" displaytext="O campo Fornecedor não pode ser vazio."/>
                        </validates>
                    </cell>
                    <cell controltype="checkbox" colspan="5" entitylink="possuidescontoparcial" />
                    <cell controltype="checkbox" colspan="5" entitylink="possuidescontoglobal" />
                    <cell controltype="number" colspan="5" entitylink="descontoglobal" />
                    <cell controltype="textedit" colspan="5" entitylink="descontoglobaltipo" visible="possuidescontoglobal" defaultvalue="1">
                        <validates>
                            <validate type="vnull" displaytext="O campo Tipo de Desconto Global não pode estar vazio"></validate>
                        </validates>
                    </cell>
                </row>
            </headerform>
        </layout>
    </form>
  </forms>
    <actions>
        <action form="default">
            <name>retrieve</name>
        </action>
        <action form="default">
            <name>Insert</name>
            <api>
                <name>fornecedorenvolvidonovo_v2</name>
                <fromto valueapi="negocio" valueentity="negocio"/>
                <fromto valueapi="fornecedor" valueentity="fornecedor"/>
                <fromto valueapi="acionamentometodo" valueentity="acionamentometodo"/>
                <fromto valueapi="acionamentorespostaprazo" valueentity="acionamentorespostaprazo"/>
                <fromto valueapi="created_by" valueentity="logged_user"/>
                <fromto valueapi="tenant" valueentity="tenant"/>
                <fromto valueapi="id_grupoempresarial" valueentity="id_grupoempresarial"/>
            </api>
        </action>
        <action>
            <name>Delete</name>
            <api>
                <name>fornecedorenvolvidoexcluir_v3</name>
                <fromto valueapi="fornecedorenvolvido" valueentity="fornecedorenvolvido"/>
                <fromto valueapi="negocio" valueentity="negocio"/>
                <fromto valueapi="fornecedor" valueentity="fornecedor"/>
                <fromto valueapi="nomeFornecedor" valueentity="fornecedor.nome"/> <!-- feito via sobrescricao do repository -->
                <fromto valueapi="id_grupoempresarial" valueentity="id_grupoempresarial"/>
                <fromto valueapi="deleted_by" valueentity="logged_user"/>
                <fromto valueapi="tenant" valueentity="tenant"/>
            </api>
        </action>
        <action form="aprovar" layer="front"> <!-- Layer front não cria service, repository e não necessida de api do banco -->
            <name>aprovarOrcamentosNegocioFornecedor</name>
            <api>
                <name>aprovarOrcamentosNegocioFornecedor</name>
                <fromto valueapi="negocio" valueentity="negocio"/>
                <fromto valueapi="fornecedor" valueentity="fornecedor"/>
                <fromto valueapi="updated_by" valueentity="logged_user"/>
                <fromto valueapi="tenant" valueentity="tenant"/>
                <fromto valueapi="id_grupoempresarial" valueentity="id_grupoempresarial"/>
            </api> 
        </action>
        <action layer="front"> <!-- Layer front não cria service, repository e não necessida de api do banco -->
            <name>reabrirorcamentosnegociofornecedor</name>
            <api>
                <name>reabrirorcamentosnegociofornecedor</name>
                <fromto valueapi="negocio" valueentity="negocio"/>
                <fromto valueapi="fornecedor" valueentity="fornecedor"/>
                <fromto valueapi="updated_by" valueentity="logged_user"/>
                <fromto valueapi="tenant" valueentity="tenant"/>
                <fromto valueapi="id_grupoempresarial" valueentity="id_grupoempresarial"/>
            </api> 
        </action>
        <action form="atualizarconfiguracaodescontos">
            <name>fornecedorenvolvidoatualizarconfiguracaodescontos</name>
            <api>
                <name>fornecedorenvolvidoatualizarconfiguracaodescontos</name>
                <fromto valueapi="negocio" valueentity="negocio"/>
                <fromto valueapi="fornecedor" valueentity="fornecedor"/>
                <fromto valueapi="possuidescontoparcial" valueentity="possuidescontoparcial"/>
                <fromto valueapi="possuidescontoglobal" valueentity="possuidescontoglobal"/>
                <fromto valueapi="descontoglobal" valueentity="descontoglobal"/>
                <fromto valueapi="descontoglobaltipo" valueentity="descontoglobaltipo"/>
                <fromto valueapi="updated_by" valueentity="logged_user"/>
                <fromto valueapi="tenant" valueentity="tenant"/>
                <fromto valueapi="id_grupoempresarial" valueentity="id_grupoempresarial"/>
            </api> 
        </action>
        <action layer="back">
            <name>fornecedorenvolvidoatualizardescontoorcamentos</name>
            <api>
                <name>fornecedorenvolvidoatualizardescontoorcamentos_v2</name>
                <fromto valueapi="negocio" valueentity="negocio"/>
                <fromto valueapi="fornecedor" valueentity="fornecedor"/>
                <fromto valueapi="possuidescontoparcial" valueentity="possuidescontoparcial"/>
                <fromto valueapi="possuidescontoglobal" valueentity="possuidescontoglobal"/>
                <fromto valueapi="descontoglobalunitario" valueentity="descontoglobalunitario"/>
                <fromto valueapi="descontoglobalresto" valueentity="descontoglobalresto"/>
                <fromto valueapi="descontoglobalrestoorcamento" valueentity="descontoglobalrestoorcamento"/>
                <fromto valueapi="updated_by" valueentity="logged_user"/>
                <fromto valueapi="tenant" valueentity="tenant"/>
                <fromto valueapi="id_grupoempresarial" valueentity="id_grupoempresarial"/>
            </api> 
        </action>
    </actions>
</nsjusecase>