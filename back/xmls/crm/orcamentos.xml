<?xml version="1.0" encoding="UTF-8"?>
<nsjusecase xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../vendor/nasajon/mdatransformer/schemas/nsjusecase.xsd" name="orcamentos" label="orcamentos" project="crm">
  <entity schema="crm" table="orcamentos">
    <!--
      Atenção:
      ao realizar alterações neste model, por favor conferir o arquivo 
      AppBundle/Repository/Crm/OrcamentosRepository.php
      e fazer as devidas modificações (pois o repository foi sobrescrito)
    -->
    <fieldmodel name="orcamento" datatype="guid" isid="true" column="orcamento"/>
    
    <fieldmodel name="atc" datatype="guid" column="atc"/>
    <fieldmodel name="composicao" datatype="guid" column="composicao" />
    <fieldmodel name="familia" datatype="guid" column="familia" />
    <fieldmodel name="descricaomanual" datatype="boolean" column="descricaomanual"/>
    <fieldmodel name="descricao" datatype="string" column="descricao"/>
    <fieldmodel name="custo" datatype="float" column="custo"/>
    <fieldmodel name="valorunitario" datatype="float" column="valorunitario"/>
    <fieldmodel name="quantidade" datatype="integer" column="quantidade"/>
    <fieldmodel name="servicotipo" datatype="integer" column="servicotipo"/> <!-- 1: Serviço Externo. 2: Serviço Prestadora Acionada -->
    <fieldmodel name="fornecedor" datatype="guid" column="fornecedor" useCaseLink="ns\fornecedores" entityJoinType="left"/>
    <fieldmodel name="propostaitem" datatype="guid" column="propostaitem" />
    <fieldmodel name="itemfaturamento" datatype="guid" column="itemfaturamento" useCaseLink="servicos\itensdefaturamento" entityJoinType="left"/>
    <fieldmodel name="valor" datatype="moeda" column="valor"/>
    <fieldmodel name="status" datatype="integer" column="status"/> <!-- options: 0 = aberto; 1= enviado; 2 = aprovado; 3 = recusado -->
    <fieldmodel name="created_at" datatype="datetime" column="created_at"/>
    <fieldmodel name="created_by" datatype="json" column="created_by"/>
    <fieldmodel name="updated_at" datatype="datetime" column="updated_at"/>
    <fieldmodel name="updated_by" datatype="json" column="updated_by"/>
    <fieldmodel name="tenant" datatype="integer" column="tenant"/>
    <fieldmodel name="acrescimo" datatype="float" column="acrescimo"/>
    <fieldmodel name="desconto" datatype="float" column="desconto"/>
    <fieldmodel name="descontoglobal" datatype="float" column="descontoglobal"/>
    <fieldmodel name="acrescimomotivo" datatype="string" column="acrescimomotivo"/>
    <fieldmodel name="descontomotivo" datatype="string" column="descontomotivo"/>
    <fieldmodel name="motivo" datatype="string" column="motivo"/>
    <fieldmodel name="proposta" datatype="guid" notMapped="true" />
    <fieldmodel name="execucaodeservico" datatype="boolean" column="execucaodeservico" />
    <fieldmodel name="faturar" datatype="boolean" column="faturar"/>
    <!-- 1: Não faturar. 2: Faturar Seguradora sem NFS. 3: Faturar Seguradora com NFS. 4: Faturar Cliente sem NFS. -->
    <fieldmodel name="faturamentotipo" datatype="integer" column="faturamentotipo">
        <options>{1:"Não faturar",2:"Faturar Seguradora sem NFS",3:"Faturar Seguradora com NFS",4:"Faturar Cliente com NFS"}</options>
    </fieldmodel> 
    <fieldmodel name="fornecedorterceirizado" datatype="guid" column="fornecedorterceirizado"/> 
    <fieldmodel name="valorreceber" datatype="float" column="valorreceber"/>
    <fieldmodel name="tipoatualizacao" datatype="integer" column="tipoatualizacao"/>
    <fieldmodel name="valortotalapolice" datatype="float" notMapped="true"/>
    <fieldmodel name="id_grupoempresarial" datatype="guid" column="grupoempresarial"/>
    <!-- Define se atualizo o desconto global dos orçamentos quando adicionar ou excluir um orcamento -->
    <fieldmodel name="atualizardescontosglobais" datatype="guid" notMapped="true"/>
    <!-- Marcar quando estiver utilizando como xml auxiliar e não mapeado em outro local -->
    <fieldmodel name="xmlauxiliar" datatype="boolean" notMapped="true"/>
  </entity>
  <constructors>
    <constructoritem>tenant</constructoritem>
    <constructoritem>id_grupoempresarial</constructoritem>
  </constructors>
  <viewbrowser paginate="true" layout="list" target="window" label="Orçamento">
    <filters>
      <fieldsfilters>
        <fieldfilter entitylink="propostaitem" maxoccurs="unbounded" visible="false">
            <conditions>
              <condition type="eq"/>
            </conditions>
        </fieldfilter>
        <fieldfilter entitylink="itemfaturamento" maxoccurs="unbounded" visible="false">
          <conditions>
            <condition type="eq"/>
          </conditions>
        </fieldfilter>
        <fieldfilter entitylink="status" maxoccurs="unbounded" visible="false">
            <conditions>
              <condition type="neq"/>
            </conditions>
        </fieldfilter>
        <fieldfilter entitylink="fornecedor" maxoccurs="unbounded" visible="false">
            <conditions>
              <condition type="eq"/>
            </conditions>
        </fieldfilter>
        <fieldfilter entitylink="atc" maxoccurs="unbounded" visible="false">
            <conditions>
              <condition type="eq"/>
            </conditions>
        </fieldfilter>
         <fieldfilter entitylink="composicao" maxoccurs="unbounded" visible="false">
            <conditions>
              <condition type="isNotNull"/>
            </conditions>
        </fieldfilter>
      </fieldsfilters>
    </filters>
    <fieldsbrowser>
        <fieldbrowser entitylink="orcamento" visible="true" isid="true"/>
        <fieldbrowser entitylink="fornecedor" visible="false"  fielddetaillookup="{'nome':'Nome', 'codigo':'Código', 'descricao':'Descrição'}" />
        <fieldbrowser entitylink="propostaitem" visible="false"   />
        <fieldbrowser entitylink="itemfaturamento" visible="false"  fielddetaillookup="{'servico': 'Servico', 'descricao': 'Descricao'}" />
        <fieldbrowser alias="Valor" entitylink="valor" visible="true" cansearch="false"/>
        <fieldbrowser alias="Acrescimo" entitylink="acrescimo" visible="true" cansearch="false"/>
        <fieldbrowser alias="Desconto" entitylink="desconto" visible="true" cansearch="false"/>
        <fieldbrowser alias="Desconto global" entitylink="descontoglobal" visible="true" cansearch="false"/>
        <fieldbrowser alias="Tipo de faturamento" entitylink="faturamentotipo" visible="true" cansearch="false"/>
        <fieldbrowser alias="Fornecedor Terceirizado" entitylink="fornecedorterceirizado" visible="true" cansearch="false"/>
        <fieldbrowser entitylink="atc" visible="false" cansearch="false" />
        <fieldbrowser entitylink="composicao" visible="false" />
        <fieldbrowser entitylink="familia" visible="false" />
        <fieldbrowser entitylink="descricaomanual" visible="false" cansearch="false" />
        <fieldbrowser entitylink="descricao" visible="false" cansearch="false" />
        <fieldbrowser entitylink="custo" visible="false" cansearch="false" />
        <fieldbrowser entitylink="valorunitario" visible="false" cansearch="false" />
        <fieldbrowser entitylink="quantidade" visible="false" cansearch="false" />
        <fieldbrowser entitylink="motivo" visible="false" cansearch="false" />
        <fieldbrowser entitylink="status" visible="false" cansearch="false" />
        <fieldbrowser entitylink="faturar" visible="true"/>
        <fieldbrowser entitylink="updated_at" visible="false" cansearch="false" />
        <fieldbrowser entitylink="valorreceber" visible="false" cansearch="false" />
        <fieldbrowser entitylink="tipoatualizacao" visible="false"/>
        <fieldbrowser entitylink="valortotalapolice" visible="false"/>
    </fieldsbrowser>
  </viewbrowser>
  <forms>
    <form name="default" label="Orcamentos">
      <layout>
        <headerform>
        <row>
            <cell controltype="hidden" entitylink="xmlauxiliar"/>
            <cell controltype="hidden" entitylink="orcamento"/>
        </row>
          <row>
            <cell controltype="lookup" label="Fornecedor" colspan="12" entitylink="fornecedor" fielddetaillookup="{'nome':'Nome'}">
            </cell>
          </row>
          <!-- O campo só será utilizado se o orçamento for do tipo Serviço e o propostaitem não for passado -->
          <row visible="!xmlauxiliar &amp;&amp; composicao &amp;&amp; !propostaitem">
            <cell label="proposta" controltype="textedit" colspan="6" entitylink="proposta">
                <validates>
                    <validate type="vnull" displaytext="O campo Proposta não pode ser vazio."/>
                </validates>
            </cell>
          </row>
          <row>
            <cell label="propostaitem" controltype="textedit" colspan="6" entitylink="propostaitem"/>
          </row>
          <row visible="!xmlauxiliar">
            <cell controltype="textedit" colspan="6" label="Serviço" entitylink="composicao" visible="!familia">
                <validates>
                    <validate type="vnull" displaytext="O campo Serviço não pode ser vazio."/>
                </validates>
            </cell>
          </row>
          <row visible="!xmlauxiliar">
            <cell controltype="textedit" colspan="6" label="Mercadoria" entitylink="familia" visible="!composicao">
                <validates>
                    <validate type="vnull" displaytext="O campo Mercadoria não pode ser vazio."/>
                </validates>
            </cell>
          </row>
          <row>
            <cell label="descricaomanual" controltype="checkbox" colspan="6" entitylink="descricaomanual"
                readonly="orcamento"/>
          </row>
          <row>
            <cell label="descricao" controltype="textedit" colspan="6" entitylink="descricao"
                readonly="!descricaomanual"/>
          </row>
          <row>
            <cell label="atc" controltype="textedit" colspan="6" entitylink="atc"/>
          </row>
          <row>
            <cell label="custo" controltype="number" colspan="6" entitylink="custo"/>
            <cell label="valorunitario" controltype="number" colspan="6" entitylink="valorunitario"/>
            <cell label="quantidade" controltype="number" colspan="6" entitylink="quantidade"/>
          </row>
          <row>
            <cell label="valor receber" controltype="number" colspan="6" entitylink="valorreceber"/>
          </row>
          <row>
            <cell label="desconto" controltype="number" colspan="6" entitylink="desconto"/>
          </row>
          <row>
            <cell label="acrescimo" controltype="number" colspan="6" entitylink="acrescimo"/>
          </row>
          <row>
            <cell controltype="textedit" colspan="6" entitylink="proposta"/>
          </row>
          <row>
            <cell controltype="textedit" colspan="6" entitylink="execucaodeservico"/>
          </row>
          <row>
            <cell controltype="textedit" colspan="6" entitylink="motivo"/>
          </row>
          <row>
            <cell label="faturamentotipo" controltype="hidden" colspan="6" entitylink="faturamentotipo" defaultvalue="1">
            </cell>
          </row>
          <row>
            <cell label="tipoatualizacao" controltype="textedit" colspan="6" entitylink="tipoatualizacao"/>
          </row>
          <row>
            <cell label="atualizardescontosglobais" controltype="hidden" defaultvalue="true" entitylink="atualizardescontosglobais"/>
          </row>
        </headerform>
      </layout>
    </form>
  </forms>
  <actions>
    <action>
      <name>retrieve</name>
    </action>
    <action>
      <name>Insert</name>
      <api>
        <name>orcamentoNovo_v7</name>
        <fromto valueapi="tenant" valueentity="tenant"/>
        <fromto valueapi="grupoempresarial" valueentity="id_grupoempresarial"/>
        <fromto valueapi="created_by" valueentity ="logged_user"/>
        <fromto valueapi="fornecedor" valueentity="fornecedor"/>
        <fromto valueapi="atc" valueentity="atc"/>
        <fromto valueapi="composicao" valueentity="composicao"/>
        <fromto valueapi="familia" valueentity="familia"/>
        <fromto valueapi="proposta" valueentity="proposta"/>
        <fromto valueapi="propostaitem" valueentity="propostaitem"/>
        <fromto valueapi="custo" valueentity="custo"/>
        <fromto valueapi="valorunitario" valueentity="valorunitario"/>
        <fromto valueapi="quantidade" valueentity="quantidade"/>
        <fromto valueapi="valorreceber" valueentity="valorreceber"/>
        <fromto valueapi="desconto" valueentity="desconto"/>
        <fromto valueapi="descontomotivo" valueentity="descontomotivo"/>
        <fromto valueapi="acrescimo" valueentity="acrescimo"/>
        <fromto valueapi="acrescimomotivo" valueentity="acrescimomotivo"/>
        <fromto valueapi="descricaomanual" valueentity="descricaomanual"/>
        <fromto valueapi="descricao" valueentity="descricao"/>
        <fromto valueapi="itemfaturamento" valueentity="itemfaturamento"/>
        <fromto valueapi="faturamentotipo" valueentity="faturamentotipo"/>
        <fromto valueapi="tipoatualizacao" valueentity="tipoatualizacao"/>
      </api>
    </action>
    <action>
      <name>Update</name>
      <api>
        <name>orcamentoAlterar_v8</name>
        <fromto valueapi="orcamento" valueentity="orcamento"/>
        <fromto valueapi="tenant" valueentity="tenant"/>
        <fromto valueapi="grupoempresarial" valueentity="id_grupoempresarial"/>
        <fromto valueapi="updated_by" valueentity ="logged_user"/>
        <fromto valueapi="custo" valueentity="custo"/>
        <fromto valueapi="valorunitario" valueentity="valorunitario"/>
        <fromto valueapi="quantidade" valueentity="quantidade"/>
        <fromto valueapi="valorreceber" valueentity="valorreceber"/>
        <fromto valueapi="desconto" valueentity="desconto"/>
        <fromto valueapi="descontomotivo" valueentity="descontomotivo"/>
        <fromto valueapi="acrescimo" valueentity="acrescimo"/>
        <fromto valueapi="acrescimomotivo" valueentity="acrescimomotivo"/>
        <fromto valueapi="descricao" valueentity="descricao"/>
        <fromto valueapi="faturamentotipo" valueentity="faturamentotipo"/>
        <fromto valueapi="tipoatualizacao" valueentity="tipoatualizacao"/>
      </api>
    </action>
    <action>
      <name>enviar</name>
      <api>
        <name>orcamentoEnviar_v2</name>
        <fromto valueapi="orcamento" valueentity="orcamento"/>
        <fromto valueapi="updated_by" valueentity ="logged_user"/>
        <fromto valueapi="tenant" valueentity="tenant"/>
        <fromto valueapi="grupoempresarial" valueentity="id_grupoempresarial"/>
      </api>
    </action>
    <action>
      <name>aprovar</name>
      <api>
        <name>orcamentoAprovar_v2</name>
        <fromto valueapi="orcamento" valueentity="orcamento"/>
        <fromto valueapi="updated_by" valueentity ="logged_user"/>
        <fromto valueapi="tenant" valueentity="tenant"/>
        <fromto valueapi="grupoempresarial" valueentity="id_grupoempresarial"/>
      </api>
    </action>
    <action>
      <name>renegociar</name>
      <api>
        <name>orcamentoRenegociar_v2</name>
        <fromto valueapi="orcamento" valueentity="orcamento"/>
        <fromto valueapi="updated_by" valueentity ="logged_user"/>
        <fromto valueapi="tenant" valueentity="tenant"/>
        <fromto valueapi="motivo" valueentity="motivo"/>
        <fromto valueapi="grupoempresarial" valueentity="id_grupoempresarial"/>
      </api>
    </action>
    <action>
      <name>reprovar</name>
      <api>
        <name>orcamentoReprovar_v2</name>
        <fromto valueapi="orcamento" valueentity="orcamento"/>
        <fromto valueapi="updated_by" valueentity ="logged_user"/>
        <fromto valueapi="tenant" valueentity="tenant"/>
        <fromto valueapi="motivo" valueentity="motivo"/>
        <fromto valueapi="grupoempresarial" valueentity="id_grupoempresarial"/>
      </api>
    </action>
    <action>
      <name>Delete</name>
      <api>
        <name>orcamentoExcluir_v3</name>
        <fromto valueapi="orcamento" valueentity="orcamento"/>
        <fromto valueapi="tenant" valueentity="tenant"/>
        <fromto valueapi="grupoempresarial" valueentity="id_grupoempresarial"/>
        <fromto valueapi="deleted_by" valueentity ="logged_user"/>
      </api>
    </action>
    <action layer="back">
        <name>reabrir</name>
        <api>
          <name>orcamentoReabrir</name>
          <fromto valueapi="orcamento" valueentity="orcamento"/>
          <fromto valueapi="tenant" valueentity="tenant"/>
          <fromto valueapi="grupoempresarial" valueentity="id_grupoempresarial"/>
          <fromto valueapi="updated_by" valueentity ="logged_user"/>
        </api>
    </action>
  </actions>
</nsjusecase>
